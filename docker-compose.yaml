version: "3.8"

services:
  postgres:
    image: 'pgvector/pgvector:pg17'
    user: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${SERVICE_USER_POSTGRES}
      - POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}
      - POSTGRES_DB=${POSTGRES_DB:-lobechat}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - type: bind
        source: ./init-logto-db.sql
        target: /docker-entrypoint-initdb.d/init-logto-db.sql

  minio:
    image: ghcr.io/coollabsio/minio:RELEASE.2025-10-15T17-29-55Z
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_SERVER_URL=${MINIO_SERVER_URL}
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL}
      - MINIO_ROOT_USER=${SERVICE_USER_MINIO}
      - MINIO_ROOT_PASSWORD=${SERVICE_PASSWORD_MINIO}
    volumes:
      - minio-data:/data

  minio-setup:
    image: ghcr.io/coollabsio/minio:RELEASE.2025-10-15T17-29-55Z
    restart: "no"
    depends_on:
      minio:
        condition: service_healthy
    exclude_from_hc: true
    environment:
      - MINIO_ROOT_USER=${SERVICE_USER_MINIO}
      - MINIO_ROOT_PASSWORD=${SERVICE_PASSWORD_MINIO}
    entrypoint: ["/bin/sh", "-lc"]
    command: |
      set -e
      until mc alias set myminio http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"; do
        echo "Waiting for MinIO..."
        sleep 1
      done
      mc mb -p myminio/lobe || true
      mc anonymous set public myminio/lobe || true
      exit 0

  logto:
    image: 'svhd/logto:${TAG-latest}'
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint:
      - sh
      - '-c'
      - 'npm run cli db seed -- --swe && npm start'
    environment:
      - TRUST_PROXY_HEADER=1
      - DB_URL=${DB_URL_LOGTO}
      - ENDPOINT=${LOGTO_ENDPOINT:?}
      - ADMIN_ENDPOINT=${LOGTO_ADMIN_ENDPOINT:?}

  lobechat:
    image: 'lobehub/lobe-chat-database:${TAG-latest}'
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      logto:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    environment:
      - LOBECHAT_PUBLIC_URL=${LOBECHAT_PUBLIC_URL:?}
      - APP_URL=${LOBECHAT_PUBLIC_URL}
      - NEXTAUTH_URL=${LOBECHAT_PUBLIC_URL}api/auth
      - DATABASE_DRIVER=node
      - DATABASE_URL=${DATABASE_URL_LOBECHAT}
      - KEY_VAULTS_SECRET=${SERVICE_BASE64_64_KEYVAULTS}
      - NEXT_AUTH_SECRET=${SERVICE_BASE64_64_NEXTAUTH}
      - S3_ACCESS_KEY_ID=${SERVICE_USER_MINIO}
      - S3_SECRET_ACCESS_KEY=${SERVICE_PASSWORD_MINIO}
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=lobe
      - S3_ENABLE_PATH_STYLE=1
      - S3_PUBLIC_DOMAIN=${MINIO_SERVER_URL}
      - NEXT_AUTH_SSO_PROVIDERS=logto
      - AUTH_LOGTO_ISSUER=${LOGTO_ENDPOINT}/oidc
      - AUTH_LOGTO_ID=${AUTH_LOGTO_ID:-__SET_AFTER_LOGTO_APP__}
      - AUTH_LOGTO_SECRET=${AUTH_LOGTO_SECRET:-__SET_AFTER_LOGTO_APP__}
      - OPENAI_API_KEY=${OPENAI_API_KEY:?}
      - NEXT_PUBLIC_SERVICE_MODE=server
      - LLM_VISION_IMAGE_USE_BASE64=1
      - NODE_OPTIONS=--max-old-space-size=4096

volumes:
  postgres-data:
  minio-data:
